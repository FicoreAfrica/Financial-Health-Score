<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="{{ session.language|default('en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ translations['Bill Planner'] }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f4f4f4; }
        .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; }
        .header { text-align: center; padding: 10px; background: linear-gradient(to right, #2E7D32, #0288D1); color: #fff; border-radius: 8px 8px 0 0; }
        .form-label { font-weight: bold; }
        .form-control, .form-select { border-radius: 5px; }
        .btn-primary { background: #1E7F71; border: none; }
        .btn-primary:hover { background: #0288D1; }
        .tooltip-text { font-size: 0.9em; color: #666; }
        .table { margin-top: 20px; }
        .calendar { margin: 20px 0; }
        .insights { margin: 20px 0; }
        .recommendation { background: #e8f4f8; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>{{ translations['Bill Planner'] }}</h2>
            <p>{{ translations['Financial growth passport for Africa'] }}</p>
        </div>
        <div class="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <h3>{{ translations['Add or Update a Bill'] }}</h3>
            <form method="POST" action="{{ url_for('bill_planner_dashboard') }}">
                {{ form.hidden_tag() }}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.first_name.label(class="form-label", for="first_name") }}
                        {{ form.first_name(class="form-control", id="first_name", required=True, **{'aria-required': 'true'}) }}
                        <div class="tooltip-text">{{ translations['Enter your first name to personalize your results.'] }}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.email.label(class="form-label", for="email") }}
                        {{ form.email(class="form-control", id="email", required=True, **{'aria-required': 'true', 'readonly': 'readonly'}) }}
readystatechange: loaded
                        <div class="tooltip-text">{{ translations['Your email is used to track your bills.'] }}</div>
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.language.label(class="form-label", for="language") }}
                    {{ form.language(class="form-select", id="language", required=True, **{'aria-required': 'true'}) }}
                    <div class="tooltip-text">{{ translations['Choose your preferred language for the planner.'] }}</div>
                </div>
                <div class="mb-3">
                    {{ form.description.label(class="form-label", for="description") }}
                    {{ form.description(class="form-control", id="description", required=True, **{'aria-required': 'true'}) }}
                    <div class="tooltip-text">{{ translations['What is this bill for?'] }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.amount.label(class="form-label", for="amount") }}
                        {{ form.amount(class="form-control", id="amount", required=True, **{'aria-required': 'true'}) }}
                        <div class="tooltip-text">{{ translations['How much is the bill? Enter in Naira (₦).'] }}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.due_date.label(class="form-label", for="due_date") }}
                        {{ form.due_date(class="form-control", id="due_date", required=True, **{'aria-required': 'true'}) }}
                        <div class="tooltip-text">{{ translations['When is this bill due?'] }}</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.category.label(class="form-label", for="category") }}
                        {{ form.category(class="form-select", id="category", required=True, **{'aria-required': 'true'}) }}
                        <div class="tooltip-text">{{ translations['Choose the type of bill.'] }}</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.recurrence.label(class="form-label", for="recurrence") }}
                        {{ form.recurrence(class="form-select", id="recurrence", required=True, **{'aria-required': 'true'}) }}
                        <div class="tooltip-text">{{ translations['How often does this bill occur?'] }}</div>
                    </div>
                </div>
                <div class="mb-3 form-check">
                    {{ form.send_email(class="form-check-input", id="send_email") }}
                    {{ form.send_email.label(class="form-check-label", for="send_email") }}
                    <div class="tooltip-text">{{ translations['Check to receive email reminders for this bill.'] }}</div>
                </div>
                <div class="mb-3">
                    {{ form.record_id.label(class="form-label", for="record_id") }}
                    {{ form.record_id(class="form-control", id="record_id") }}
                    <div class="tooltip-text">{{ translations['Select a bill to edit or create a new one.'] }}</div>
                </div>
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">
                        {{ translations['Save Bill'] }}
                    </button>
                    <span class="ms-2">{{ translations['Saving your bill...'] }}</span>
                </div>
            </form>
            {% if bills %}
                <h3>{{ translations['Your Bills'] }}</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>{{ translations['Description'] }}</th>
                            <th>{{ translations['Amount'] }} (₦)</th>
                            <th>{{ translations['Due Date'] }}</th>
                            <th>{{ translations['Status'] }}</th>
                            <th>{{ translations['Edit'] }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in bills %}
                            <tr>
                                <td>{{ bill.Description }}</td>
                                <td>{{ bill.Amount }}</td>
                                <td>{{ bill.DueDate }}</td>
                                <td>
                                    <a href="{{ url_for('toggle_status', record_id=bill.RecordID) }}" class="btn btn-sm {{ 'btn-success' if bill.Status == 'Paid' else 'btn-warning' if bill.Status == 'Pending' else 'btn-danger' }}">
                                        {{ translations[bill.Status] }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{{ url_for('bill_planner_dashboard') }}?record_id={{ bill.RecordID }}" class="btn btn-sm btn-primary">{{ translations['Edit'] }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
            <div class="calendar" id="calendar"></div>
            <div class="insights">
                <h3>{{ translations['Your Financial Insights'] }}</h3>
                <canvas id="billChart" width="400" height="200"></canvas>
            </div>
            <div class="recommendation">
                <p>
                    {% if bills|selectattr('Category', 'equalto', 'rent')|list %}
                        {{ translations['Use mobile money for timely rent payments to avoid late fees.'] }}
                    {% elif bills|selectattr('Category', 'equalto', 'utilities')|list %}
                        {{ translations['Switch to energy-efficient utilities to reduce bills.'] }}
                    {% else %}
                        {{ translations['Plan recurring bills to manage cash flow effectively.'] }}
                    {% endif %}
                </p>
            </div>
            <p>
                {{ translations['Share your bill summary'] }}:
                <a href="{{ whatsapp_url|default('#') }}" class="btn btn-primary">WhatsApp</a>
                <a href="{{ twitter_url|default('#') }}" class="btn btn-primary">Twitter</a>
            </p>
            <p>{{ translations['Contact Us'] }} <a href="mailto:support@ficoreafrica.com">{{ translations['Click to Email'] }}</a> {{ translations['for support'] }}</p>
            <p><a href="https://example.com/feedback">{{ translations['Provide Feedback'] }}</a></p>
        </div>
        <div class="footer">
            © 2025 Ficore Africa. All rights reserved.
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        // Initialize FullCalendar
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: [
                    {% for bill in bills %}
                        {
                            title: '{{ bill.Description }} (₦{{ bill.Amount }})',
                            start: '{{ bill.DueDate }}',
                            backgroundColor: '{{ '#2E7D32' if bill.Status == 'Pending' else '#dc3545' if bill.Status == 'Overdue' else '#1E7F71' }}',
                            borderColor: '{{ '#2E7D32' if bill.Status == 'Pending' else '#dc3545' if bill.Status == 'Overdue' else '#1E7F71' }}'
                        },
                    {% endfor %}
                ],
                eventClick: function(info) {
                    alert(info.event.title + ' - Due: ' + info.event.start.toISOString().split('T')[0]);
                }
            });
            calendar.render();
        });

        // Initialize Chart.js
        const ctx = document.getElementById('billChart').getContext('2d');
        const categories = {};
        let totalBills = 0;
        let recurringBills = 0;
        {% for bill in bills %}
            categories['{{ bill.Category }}'] = (categories['{{ bill.Category }}'] || 0) + {{ bill.Amount }};
            totalBills += {{ bill.Amount }};
            {% if bill.Recurrence != 'one-time' %}
                recurringBills += {{ bill.Amount }};
            {% endif %}
        {% endfor %}
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(categories),
                datasets: [{
                    label: '{{ translations['Amount'] }} (₦)',
                    data: Object.values(categories),
                    backgroundColor: ['#2E7D32', '#0288D1', '#1E7F71', '#dc3545'],
                    borderColor: ['#2E7D32', '#0288D1', '#1E7F71', '#dc3545'],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '{{ translations['Bill Categories'] }}'
                    }
                }
            }
        });
    </script>
</body>
</html>